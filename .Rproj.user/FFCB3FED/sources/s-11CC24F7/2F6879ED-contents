---
title: "Metaketa I - Chapter 11 - Replication"
editor_options:
  chunk_output_type: console
date: \today
output:
  pdf_document:
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
---

\clearpage

# NOTES:

* This .Rmd file produces all tables, and figures reported in Chapter 11 of the Metaketa manuscript as well as the relevant tables in the Online Appendix in the order in which they appear in the text.

* The code currently exports results to folders "tables" and "figures" in this file's directory. A copy of these files is also exported directly to the book folder. These lines should be deleted when sharing the replication code or users can set option `export_to_book <- F` in the first code chunk.

* Other options include:

    * setting `prep <- FALSE` to turn off data preparation scripts 
    * `ri_p <- "ignore"` to turn off randomization inference scripts
    * `full_m1 <- FALSE` to turn off imputing 0s for m1 for cases with m3 = 0 in `madat`

* For a full clean replication empty the subfolder `data/temp` and turn on `prep` and `ri_p <- "generate"` options.

* This code requires installation of Rstan. See instructions [here](https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started).

* Package `xlsx` requires a 64 bit Java install on PCs; see eg  https://java.com/en/download/win10.jsp


```{r setup, include=F}

rm(list = ls())

# packages

pks <- c("readstata13","reshape","dotwhisker", "MASS","plyr","dplyr","foreign",
         "tidyverse","lfe","stargazer","clubSandwich", "randomizr",
         "haven","rstudioapi", "stringr", "ri", "car", "xtable", "xlsx", "rmarkdown",
         "tidyr", "dplyr", "iterators", "parallel", "gridExtra")

invisible(lapply(pks, function(x) if (!require(x, character.only=T)){install.packages(x);library(x, character.only = T)}))

# knitr options
require(knitr)
opts_knit$set(warning = FALSE, message = FALSE)
options(knitr.duplicate.label = 'allow')

# create output folders
if(!"figures"%in%dir(file.path(getwd()))) dir.create(file.path(getwd(), "figures"))
if(!"tables"%in%dir(file.path(getwd()))) dir.create(file.path(getwd(), "tables"))
```

```{r}
# SET REPLICATION OPTIONS
  # prepare data
  prep <- TRUE
  # RI p-values could be generated from scratch, "generate", "load" from file, or "ignore"
  ri_action <- "generate"
  #number of RI permutations; 10 for trial runs; >2000 for real runs (slow)
  n_iter <- 2000
  # load existing permutation matrices for the RITE analysis
  load_iter_matrix <- FALSE
  # run bayesian analysis (requires Rstan installation)
  run_bayes <- TRUE
  # export copy of results to book folder
  export_to_book <- TRUE
  book_dir <- "../../11 Book/4 Manuscript drafts/201804 For Copyediting/files"
  # Code m1 = 0 for cases with m1 = NA and m3 = 0
  full_m1 <- TRUE
  # load matrices for specification graphs. if FALSE will generate matrices from scratch (time intensive)
  load_specification_matrices <- TRUE

```

\clearpage

```{r, include=F}

if(prep){
  rmarkdown::render("1_prep_master.Rmd")
}

rm(list=setdiff(ls(), c("export_to_book", "book_dir", "load_iter_matrix", "run_bayes", "run_ri", "prep", "n_iter", "ri_action", "full_m1")))

# load functions
source("0a_functions_main.R")
if(run_bayes) source("0b_functions_bayes.R")
```

```{r dataprep, echo = F, cache=T, warning=F, message=F}

if(prep){
  madat <- pool_studies(add_vars= c("nij", "Q_alt", "N_alt",
                                    "lc5.councillor.party.switch", "lc5.chair.party.switch", "lc5.councillor.redistricted2016"))
  if(full_m1){
    madat$m1[is.na(madat$m1) & madat$m3==0] <- 0
    #m3==0 in Burkina Faso means unlikely to vote or definitely not voting.
    madat$m1[madat$m1==1 & madat$m3==0 & madat$ctry == "bf"] <- 0
    madat_raw <- pool_studies(dir = "data/temp")
    madat$m1_against <- ifelse(madat_raw$m1==0 & madat$m3==1, 1, 0)  
    madat$m1_against[is.na(madat$m1_against) & madat$m3==0 & madat$ctry != "bf"] <- 0
    madat$m1_against[madat$m1==1 & madat$m3==0 & madat$ctry == "bf"] <- 0
    madat$m1NA <- (is.na(madat$m1) & madat$m3 == 1)
      
  }
  save(madat, file = "data/temp/madat.Rda")
  write.csv(madat, "madat.csv")
}

load("data/temp/madat.Rda")
 
# Load previously generated permutation matrices
if(load_iter_matrix){
  load("data/temp/assign_iter.Rda")
}else{
  system.time(assign_iter <- assign_i(madat, n_iter))
  save(assign_iter, file = "data/temp/assign_iter.Rda")
}
# dim(madat)
# dim(assign_iter)

  madat_iter <- cbind.data.frame(madat, assign_iter)
  rm(assign_iter)
  save(madat_iter, file = "data/temp/madat_iter.Rda")
```


# Primary analysis: Average Effects Across Cases
<!-- ## Hypotheses and Estimation -->
<!-- * H1a: Positive information increases voter support for politicians (subgroup effect). -->
<!-- * H1b: Negative information decreases voter support for politicians (subgroup effect). -->
<!-- * H2a: Good news decreases voter turnout. -->
<!-- * H2b: Bad news increases voter turnout. -->

## The Effect of Performance Information on Electoral Support

### Figure 11.3: Treatment Effect of Information on Incumbent Vote Choice

```{r Fig11.3, include=F, echo=F, cache=T}

  cov <- "m14i+m17i+m18i+m20i+m21i+m22i+m24i+m26i+m27i"

  t1c1 <-  results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_all_g_unadj.Rda",
                  good = TRUE, depvar = "m1", exclude_councilors = FALSE)
  t1c2 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_ben_g_unadj.Rda",
                  depvar = "m1", weights = FALSE, good = TRUE, country = "ben")
  t1c3 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_brz_g_unadj.Rda",
                  depvar = "m1", weights = TRUE,  good = TRUE, country = "brz")
  t1c4 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_bf_g_unadj.Rda",
                  depvar = "m1", weights = FALSE, good = TRUE, country = "bf")
  t1c5 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_mex_g_unadj.Rda",
                  depvar = "m1", weights = FALSE, good = TRUE, country = "mex")
  t1c6 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_ug1_g_unadj.Rda",
                  depvar = "m1", weights = FALSE, good = TRUE, country = "ug1")
  t1c7 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_ug2_g_unadj.Rda",
                  depvar = "m1", weights = TRUE,  good = TRUE, country = "ug2",
                  exclude_councilors =FALSE)
  
   t2c1 <-  results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_all_b_unadj.Rda",
                  good = FALSE, depvar = "m1", exclude_councilors =FALSE)
  t2c2 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_ben_b_unadj.Rda",
                  depvar = "m1", weights = FALSE, good = FALSE, country = "ben")
  t2c3 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_brz_b_unadj.Rda",
                  depvar = "m1", weights = TRUE,  good = FALSE, country = "brz")
  t2c4 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_bf_b_unadj.Rda",
                  depvar = "m1", weights = FALSE, good = FALSE, country = "bf")
  t2c5 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_mex_b_unadj.Rda",
                  depvar = "m1", weights = FALSE, good = FALSE, country = "mex")
  t2c6 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_ug1_b_unadj.Rda",
                  depvar = "m1", weights = FALSE, good = FALSE, country = "ug1")
  t2c7 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m1pool_ug2_b_unadj.Rda",
                  depvar = "m1", weights = TRUE,  good = FALSE, country = "ug2", 
                  exclude_councilors =FALSE)
 
```

```{r, include=F, echo=F, cache=T}
  source("fig3_incumbent_ctry_unadj.R")

  pdf("figures/fig_11.3_incumbent_ctry_unadj.pdf", height = 7, width = 12)
  fig11.3()
  dev.off()
  
  if(export_to_book){
  pdf(paste0(book_dir, "/incumbent_ctry_unadj.pdf"), height = 7, width = 12)
  fig11.3()
  dev.off()
  }
```

![](figures/fig_11.3_incumbent_ctry_unadj.pdf)

\clearpage

### Figure 11.4:  Treatment Effect of Information on Voter Turnout
```{r Fig11.4, include=F, echo=F, cache=T}

  t3c1 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_all_g_unadj.Rda",
                  good = TRUE, depvar = "m3", exclude_councilors =FALSE)

  t3c2 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_ben_g_unadj.Rda",
                  depvar = "m3", weights = FALSE, good = TRUE, country = "ben")
  t3c3 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_brz_g_unadj.Rda",
                  depvar = "m3", weights = TRUE,  good = TRUE, country = "brz")
  t3c4 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_bf_g_unadj.Rda",
                  depvar = "m3", weights = FALSE, good = TRUE, country = "bf")
  
```

```{r, include=F, echo=F, cache=T}
  t3c5 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_mex_g_unadj.Rda",
                  depvar = "m3", weights = FALSE, good = TRUE, country = "mex")
  t3c6 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_ug1_g_unadj.Rda",
                  depvar = "m3", weights = FALSE, good = TRUE, country = "ug1")
  t3c7 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_ug2_g_unadj.Rda",
                  depvar = "m3", weights = TRUE,  good = TRUE, country = "ug2", exclude_councilors =FALSE)

```

```{r, include=F, echo=F, cache=T}
  t4c1 <-  results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_all_b_unadj.Rda",
                  good = FALSE, depvar = "m3", exclude_councilors =FALSE)

  t4c2 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_ben_b_unadj.Rda",
                  depvar = "m3", weights = FALSE, good = FALSE, country = "ben")
  t4c3 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_brz_b_unadj.Rda",
                  depvar = "m3", weights = TRUE,  good = FALSE, country = "brz")
  t4c4 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_bf_b_unadj.Rda",
                  depvar = "m3", weights = FALSE, good = FALSE, country = "bf")
```

```{r, include=F, echo=F, cache=T}
  t4c5 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_mex_b_unadj.Rda",
                  depvar = "m3", weights = FALSE, good = FALSE, country = "mex")
  t4c6 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_ug1_b_unadj.Rda",
                  depvar = "m3", weights = FALSE, good = FALSE, country = "ug1")
  t4c7 <- results(dat = madat_iter, ri_p = ri_action, sims = n_iter,
                  file_rite_obj = "data/temp/ri_m3pool_ug2_b_unadj.Rda",
                  depvar = "m3", weights = TRUE,  good = FALSE, country = "ug2", exclude_councilors =FALSE)
  
```


```{r, include=F}

  source("fig4_turnout_ctry_unadj.R")
  
  pdf("figures/fig_11.4_turnout_ctry_unadj.pdf", height = 7, width = 12)
  fig11.4()
  dev.off()
  
  if(export_to_book){
  pdf(paste0(book_dir, "/turnout_ctry_unadj.pdf"), height = 7, width = 12)
  fig11.4()
  dev.off()
  }

```

![](figures/fig_11.4_turnout_ctry_unadj.pdf)

\clearpage

<!-- ## Consistency of Results Across Studies -->

### Table 11.1

```{r, include=F, cache=T}
# Treatment effects with nij and covariates
cov <- "m14i+m17i+m18i+m20i+m21i+m22i+m24i+m26i+m27i"

# vote choice
# good news
system.time(
t1ncovc2 <- results(dat = madat_iter, sims = n_iter, ri_p = ri_action,
                    file_rite_obj = "data/temp/ri_m1pool_all_g_cov.Rda",
                    cov = cov, good = TRUE, with_N = TRUE, weights = TRUE, depvar = "m1", exclude_councilors = FALSE)
)
# bad news
t2ncovc2 <- results(dat = madat_iter, sims = n_iter, ri_p = ri_action,
                    file_rite_obj = "data/temp/ri_m1pool_all_b_cov.Rda",
                    cov = cov, good = FALSE, with_N = TRUE, weights = TRUE, depvar = "m1", exclude_councilors = FALSE)

# turnout
#good news
t3ncovc2 <- results(dat = madat_iter, sims = n_iter, ri_p = ri_action,
                    file_rite_obj = "data/temp/ri_m3pool_all_g_cov.Rda",
                    cov = cov, good = TRUE, with_N = TRUE, weights = TRUE, depvar = "m3", exclude_councilors = FALSE)
# bad news
t4ncovc2 <- results(dat = madat_iter, sims = n_iter, ri_p = ri_action, 
                    file_rite_obj = "data/temp/ri_m3pool_all_b_cov.Rda",
                    cov = cov, good = FALSE, with_N = TRUE, weights = TRUE, depvar = "m3", exclude_councilors = FALSE)

# vote choice overall
t_m1_o <- results(dat = madat_iter, sims = n_iter, ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_all_o_cov.Rda",
                  cov = cov, with_N = TRUE, depvar = "m1", exclude_councilors =FALSE)

# turnout overall
t_m3_o <- results(dat = madat_iter, sims = n_iter, ri_p = ri_action, file_rite_obj = "data/temp/ri_m3pool_all_o_cov.Rda",
                  cov = cov, with_N = TRUE, depvar = "m3", exclude_councilors =FALSE)

```

```{r, results='asis', echo=FALSE}
  source("tab1_main_effects.R")
  cat(readLines('tables/tab_11.1_main_effects.tex'), sep = '\n')
```

\clearpage

# Secondary Analysis: A Bayesian Approach

### Figure 11.5: Bayesian Meta-Analysis: Vote Choice

```{r, include=F, eval=run_bayes}
  library("rstan")
  rstan_options(auto_write = TRUE)
  options(mc.cores = parallel::detectCores())
```

```{r stan, include = F, warning=F, message=F, eval=run_bayes}
# Stan code used in Fig 11.5 and 11.6 to sample from posterior distributions

  bmodel <- "
  data {
    int<lower=0> J; // number of countries 
    real y[J]; // estimated treatment effects
    real<lower=0> sigma[J]; // s.e. of effect estimates 
  }
  parameters {
    real mu; 
    real<lower=0> tau;
    real eta[J];
  }
  transformed parameters {
    real theta[J];
    for (j in 1:J)
      theta[j] = mu + tau * eta[j];
  }
  model {
    target += normal_lpdf(eta | 0, 1);
    target += normal_lpdf(y | theta, sigma);
  }
  "

```

```{r posterior_run, include=F, cache=T, eval=run_bayes}
  
  # Function to make data from model
  take_results <- function(L) {
    out <- lapply(L, function(i)  coef(summary(i))[1,1:2])
    t(matrix(unlist(out),nrow = 2))
  }

  ### M1: Incumbent vote ###
  good_m1 <- take_results(lapply(list(t1c1, t1c2, t1c3, t1c4, t1c5, t1c6, t1c7), function(i) i$estimates))
  bad_m1 <- take_results(lapply(list(t2c1, t2c2, t2c3, t2c4, t2c5, t2c6, t2c7), function(i) i$estimates))

  ### M3: Turn out###
  good_m3 <- take_results(lapply(list(t3c1, t3c2, t3c3, t3c4, t3c5, t3c6, t3c7), function(i) i$estimates))
  bad_m3 <- take_results(lapply(list(t4c1, t4c2, t4c3, t4c4, t4c5, t4c6, t4c7), function(i) i$estimates))

```

```{r bayesfig1, include=F, cache=T, eval=run_bayes}

  ### M1: Incumbent vote ###
  
  pdf("figures/fig_11.5_posteriors_incumbent.pdf", height = 7, width = 12)
  mar.default <- c(5,4,4,2) + 0.1
  par(mfrow = c(1,2),mar = mar.default + c(0, 2, 0, 0))
  bayes_result(my_data = good_m1, main = "Effects of Good News on Vote Choice")
  bayes_result(my_data = bad_m1,  main = "Effects of Bad News on Vote Choice")
  dev.off()
  
  if(export_to_book){
  pdf(paste0(book_dir, "/Effects_on_Vote.pdf"), height = 7, width = 12)
  mar.default <- c(5,4,4,2) + 0.1
  par(mfrow = c(1,2),mar = mar.default + c(0, 2, 0, 0))
  bayes_result(my_data = good_m1, main = "Effects of Good News on Vote Choice")
  bayes_result(my_data = bad_m1,  main = "Effects of Bad News on Vote Choice")
  dev.off()
  }
  
```

![](figures/fig_11.5_posteriors_incumbent.pdf)

\clearpage

### Figure 11.6: Bayesian Meta-Analysis: Turnout

```{r bayesfig2, include=F, cache=T, eval=run_bayes}
  
  ### M3: Turn out###
  
  pdf("figures/fig_11.6_posteriors_turnout.pdf", height = 7, width = 12)
  mar.default <- c(5,4,4,2) + 0.1
  par(mfrow = c(1,2),mar = mar.default + c(0, 2, 0, 0)) 
  bayes_result(my_data = good_m3, main = "Effects of Good News on Turnout")
  bayes_result(my_data = bad_m3,  main = "Effects of Bad News on Turnout")
  dev.off()

  if(export_to_book){
  pdf(paste0(book_dir, "/Meta_Bayes_Turnout.pdf"), height = 7, width = 12)
  mar.default <- c(5,4,4,2) + 0.1
  par(mfrow = c(1,2),mar = mar.default + c(0, 2, 0, 0))
  bayes_result(my_data = good_m3, main = "Effects of Good News on Turnout")
  bayes_result(my_data = bad_m3,  main = "Effects of Bad News on Turnout")
  dev.off()
  }
  
  rm(bayes_result, my_data)
  
```

![](figures/fig_11.6_posteriors_turnout.pdf)
\clearpage

<!-- # Robustness of Results -->
<!-- ## Reliability of outcome data -->
<!-- ## The missing India study -->
<!-- ## Country-specific analyses vs. Meta-analysis -->

# Making Sense of The Null Findings

## Specification Choices

```{r spec, include=F, cache=T, eval=TRUE}
rmarkdown::render("fig_specification_curve.Rmd")
```

![](figures/fig_spec_curve_m1.pdf)
![](figures/fig_spec_curve_m3.pdf)

## Voter Perceptions: Reception of Information and Updating

### Table 11.2

<!-- * Additional test: Assignment to treatment increases voter knowledge about the factual content of the interventions -->

```{r vknowledge, include=F, cache=T, eval=TRUE}
# source("1d_prep_manipulation.R")
madat_m30 <- madat %>% subset(!is.na(correct))

m30mc1_o <- estimates(dat = madat_m30, depvar = "correct", exclude_councilors = TRUE) # no change in est
m30mc2_o <- estimates(dat = madat_m30, depvar = "correct", weights = FALSE, country = "ben")
m30mc3_o <- estimates(dat = madat_m30, depvar = "correct", country = "brz")
m30mc4_o <- estimates(dat = madat_m30, depvar = "correct", weights = FALSE, country = "mex")
m30mc5_o <- estimates(dat = madat_m30, depvar = "correct", weights = FALSE, country = "ug1")
m30mc6_o <- estimates(dat = madat_m30, depvar = "correct", weights = TRUE, country = "ug2", exclude_councilors = TRUE) #no change in est
```

```{r, results='asis', echo=FALSE, eval=TRUE}
  source("tab2_mcheck.R")
  cat(readLines('tables/tab_11.2_mcheck.tex'), sep = '\n')
```

```{r, echo=FALSE, results="asis"}
madat_m30b <- madat %>% subset(!is.na(post.prior.diff))
madat_m30b$post.prior.diff <- abs(madat_m30b$post.prior.diff)

# overall news
m30mc1_g <- estimates(dat = madat_m30b, good = NULL, depvar = "post.prior.diff", exclude_councilors = TRUE)
m30mc2_g <- estimates(dat = madat_m30b, good = NULL, depvar = "post.prior.diff", weights = FALSE, country = "ben")
m30mc3_g <- estimates(dat = madat_m30b, good = NULL, depvar = "post.prior.diff", country = "brz")
# m30mc5_g <- estimates(dat = madat_m30b, good = TRUE, depvar = "post.prior.diff", weights = FALSE, country = "ug1")
m30mc6_g <- estimates(dat = madat_m30b, good = NULL, depvar = "post.prior.diff", weights = TRUE, country = "ug2", exclude_councilors = TRUE)

source("tab2b_mcheck_postpriordiff.R")
cat(readLines('tables/tab_11.2_mcheck2.tex'), sep = '\n')
```


\clearpage

### Table 11.3

<!-- * H3: Positive (negative) information increases (decreases) voter beliefs in candidate integrity. -->
<!-- * H4: Positive (negative) information increases (decreases) voter beliefs that candidate is hardworking. -->
<!--     - M5 ~ T1 | M10 = 1 ov [s = ug1, ug2, bn, bf, br] -->
<!--     - M5 ~ T1 | M10 = 0 ov [s = ug1, ug2, bn, bf, br] -->
<!--     - M6 ~ T1 | M10 = 1 ov [s = ug2, mx, bn, bf, br] -->
<!--     - M6 ~ T1 | M10 = 0 ov [s = ug2, mx, bn, bf, br] -->
  
```{r m5table, include=F, cache=T}
# M5 ----
m5gc1 <- results(dat = madat_iter, good = TRUE, depvar = "m5", exclude_councilors = TRUE, sims = n_iter,
                 ri_p = ri_action, file_rite_obj = "data/temp/ri_m5pool_g_unadj.Rda")
## good news

m5bc1 <- results(dat = madat_iter, good = FALSE, depvar = "m5", exclude_councilors = TRUE, sims = n_iter,
                   ri_p = ri_action, file_rite_obj = "data/temp/ri_m5pool_b_unadj.Rda") ## bad news
# M6 ----
m6gc1 <- results(dat = madat_iter, good = TRUE, depvar = "m6", exclude_councilors = TRUE, sims = n_iter,
                   ri_p = ri_action, file_rite_obj = "data/temp/ri_m6pool_g_unadj.Rda")  ## good news

m6bc1 <- results(dat = madat_iter, good = FALSE, depvar = "m6", exclude_councilors = TRUE, sims = n_iter,
                   ri_p = ri_action, file_rite_obj = "data/temp/ri_m6pool_b_unadj.Rda") ## bad news

```

```{r, results='asis', echo=FALSE}
  source("tab3_effort_honesty.R")
  cat(readLines('tables/tab_11.3_effort_honesty.tex'), sep = '\n')
```

\clearpage

### Table 11.4
<!-- * **[NOTE THIS TEST IS NOT PRE-REGISTERED; GOAL IS TO SEE WHETHER SOURCE CREDIBILITY AND TREATMENT INTERACT LOOKING AT EFFORT AND INTEGRITY AS OUTCOMES]** -->

<!--     - M5 ~ T1\*M24 | M10 = 1 ov [s = ug1, ug2, mx, bn, bf, br] -->
<!--     - M5 ~ T1\*M24 | M10 = 0 ov [s = ug1, ug2, mx, bn, bf, br] -->
<!--     - M6 ~ T1\*M24 | M10 = 1 ov [s = ug1, ug2, mx, bn, bf, br] -->
<!--     - M6 ~ T1\*M24 | M10 = 0 ov [s = ug1, ug2, mx, bn, bf, br] -->

```{r m24table, echo = F, cache=T}
# Effort
m5_m24c1_g <- results(dat = madat_iter, sims = n_iter, 
                      depvar = "m5", interactvar = "m24", good = TRUE, 
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m5pool_m24_all_g_unadj.Rda")  ## good news

m5_m24c1_b <- results(dat = madat_iter, sims = n_iter,
                      depvar = "m5", interactvar = "m24", good = FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m5pool_m24_all_b_unadj.Rda") ## bad news

# Honesty
m6_m24c1_g <- results(dat = madat_iter, sims = n_iter,
                      depvar = "m6", interactvar = "m24", good = TRUE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m6pool_m24_all_g_unadj.Rda")  ## good news

m6_m24c1_b <- results(dat = madat_iter, sims = n_iter, 
                      depvar = "m6", interactvar = "m24", good = TRUE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m6pool_m24_all_b_unadj.Rda")  ## bad news
```

```{r, results='asis', echo=FALSE}
  source("tab4_effort_honesty.R")
  cat(readLines('tables/tab_11.4_effort_honesty_credibility.tex'), sep = '\n')
```

\clearpage

### Table 11.5

```{r t11.5, echo=F, cache=T, warning=FALSE}

madat_m1pool_g <- estimates(dat = madat_iter, weights = FALSE, depvar = "m1", return_df = TRUE, good = TRUE, exclude_councilors =FALSE) # good

  madat_m1pool_g <- madat_m1pool_g %>%
    group_by(ctry) %>%
    mutate(m5 = m5 - mean(m5, na.rm = T)) %>%
    mutate(m6 = m6 - mean(m6, na.rm = T)) %>%
    ungroup()

m1m5c1g <- felm(m1~m5|fe|0|cl, data = madat_m1pool_g) 
m1m6c1g <- felm(m1~m6|fe|0|cl, data = madat_m1pool_g) 
# rm(madat_m1pool_g)


madat_m1pool_b <- estimates(dat = madat_iter, weights = FALSE, depvar = "m1", return_df = TRUE, good = FALSE, exclude_councilors =FALSE) # bad
  
madat_m1pool_b <- madat_m1pool_b %>%
    group_by(ctry) %>%
    mutate(m5 = m5 - mean(m5, na.rm = T)) %>%
    mutate(m6 = m6 - mean(m6, na.rm = T)) %>%
    ungroup()
    
m1m5c1b <- felm(m1~m5|fe|0|cl, data = madat_m1pool_b) 
m1m6c1b <- felm(m1~m6|fe|0|cl, data = madat_m1pool_b)
# rm(madat_m1pool_b)

```

```{r, results='asis', echo=FALSE}
  source("tab5_m1_effort_honesty.R")
  cat(readLines('tables/tab_11.5_m1_effort_honesty.tex'), sep = '\n')
```

\clearpage

## Politician Response

### Table 11.6

<!-- * H5: Politicians mount campaigns to respond to negative information. -->

```{r t11.6, include=F, cache=T}
m8bc1 <- results(dat = madat_iter, good = FALSE, depvar = "m8",
                 ri_p = ri_action, file_rite_obj = "data/temp/ri_m8pool_all_b_unadj.Rda", sims = n_iter)

m8bc2 <- results(dat = madat_iter, good = FALSE, depvar = "m8", weights = FALSE, country = "ben",
                 ri_p = ri_action, file_rite_obj = "data/temp/ri_m8pool_ben_b_unadj.Rda", sims = n_iter)

m8bc3 <- results(dat = madat_iter, good = FALSE, depvar = "m8", weights = FALSE, country = "mex",
                 ri_p = ri_action, file_rite_obj = "data/temp/ri_m8pool_mex_b_unadj.Rda", sims = n_iter)

```

```{r, echo=FALSE, results='asis'}
  source("tab6_backlash.R")
  cat(readLines('tables/tab_11.6_backlash.tex'), sep = '\n')
  rm(m8bc1, m8bc2, m8bc3)
```

\clearpage

## Interaction Effects

### Table 11.7
<!-- * H6: Information effects are more positive for voters that do not share _ethnic identities_. -->
<!-- * H7: Information effects are more positive for voters with weaker _partisan identities_. -->
<!-- * H8: Information effects are more positive for voters who have not received _clientelistic_ benefits from any candidate. -->

<!--     - M1 ~ T1\*M15 | M10 = 1 ov [s = ug1, ug2, bn, br] -->
<!--     - M1 ~ T1\*M15 | M10 = 0 ov [s = ug1, ug2, bn, br] -->
<!--     - M1 ~ T1\*M19 | M10 = 1 ov [dichotomoized M19, s = ug1, ug2, mx, bn, br] -->
<!--     - M1 ~ T1\*M19 | M10 = 0 ov [dichotomoized M19, s = ug1, ug2, mx, bn, br] -->
<!--     - M1 ~ T1\*M22 | M10 = 1 ov [s = ug1, ug2, mx, bn, bf, br] -->
<!--     - M1 ~ T1\*M22 | M10 = 0 ov [s = ug1, ug2, mx, bn, bf, br] -->

```{r coeth_table, include=F, cache=T}
# Coethnicity
## Good news - Mean centred 
madat_m1_coethnic_mc_g <- prepdat_coethnic(madat_m1pool_g, madat_m1pool_g$m1, 0)
m1_m15mc_g1 <- results(dat = madat_m1_coethnic_mc_g, ri_p = ri_action,
                       file_rite_obj = "data/temp/ri_m1pool_m15_g_unadj.Rda",
                       depvar = "m1", interactvar = "m15", sims = n_iter, exclude_councilors = FALSE)

# Bad news - Mean centred
madat_m1_coethnic_mc_b <- prepdat_coethnic(madat_m1pool_b, madat_m1pool_b$m1, 0)
m1_m15mc_b1 <- results(dat = madat_m1_coethnic_mc_b, ri_p = ri_action, 
                       file_rite_obj = "data/temp/ri_m1pool_m15_b_unadj.Rda",
                       depvar = "m1", interactvar = "m15", sims = n_iter, exclude_councilors = FALSE)
```

```{r copart_table, include=F, cache=T}
# Copartisan
## Good news - dichotomous 
madat_m1_copart_bin_g <- prepdat_copartisan(madat_m1pool_g, madat_m1pool_g$m1, 1)
m1_m19bin_g1 <- results(dat = madat_m1_copart_bin_g, ri_p = ri_action, 
                       file_rite_obj = "data/temp/ri_m1pool_m19_g_unadj.Rda",
                       depvar = "m1", interactvar = "m19", sims = n_iter, exclude_councilors = FALSE)
```

```{r, include=F, cache=T}
## Bad news - dichotomous 
madat_m1_copart_bin_b <- prepdat_copartisan(madat_m1pool_b, madat_m1pool_b$m1, 1)
m1_m19bin_b1 <- results(dat = madat_m1_copart_bin_b, ri_p = ri_action, 
                        file_rite_obj = "data/temp/ri_m1pool_m19_b_unadj.Rda",
                       depvar = "m1", interactvar = "m19", sims = n_iter, exclude_councilors = FALSE)
```

```{r client_table, include=F, cache=T}
# Clientelism
## Good news - Mean centred 
madat_m1_client_mc_g <- prepdat_client(madat_m1pool_g, madat_m1pool_g$m1, 0)
m1_m22mc_g1 <- results(dat = madat_m1_client_mc_g, ri_p = ri_action, 
                       file_rite_obj = "data/temp/ri_m1pool_m22_g_unadj.Rda",
                       depvar = "m1", interactvar = "m22", sims = n_iter, exclude_councilors = FALSE)
```

```{r mods, include=F, cache=T}
## Bad news - Mean centred 
madat_m1_client_mc_b <- prepdat_client(madat_m1pool_b, madat_m1pool_b$m1, 0)
m1_m22mc_b1 <- results(dat = madat_m1_client_mc_b, ri_p = ri_action, 
                       file_rite_obj = "data/temp/ri_m1pool_m22_b_unadj.Rda",
                       depvar = "m1", interactvar = "m22", sims = n_iter, exclude_councilors = FALSE)
```

```{r, results='asis', echo=FALSE}
  source("tab7_moderators.R")
  cat(readLines('tables/tab_11.7_moderators.tex'), sep = '\n')
  
  rm(madat_m1_coethnic_mc_g, madat_m1_coethnic_mc_b, madat_m1_copart_bin_g,
     madat_m1_copart_bin_b, madat_m1_client_mc_g, madat_m1_client_mc_b)

```

\clearpage

### Table 11.8

<!--     - M1 ~ T1\*M11 | M10 = 1 ov [s = ug1, ug2, bn, bf, br]  -->
<!--     - M1 ~ T1\*M11 | M10 = 0 ov [s = ug1, ug2, bn, bf, br] -->
<!--     - M1 ~ T1\*M26 | M25 = 1 ov [s = ug1, ug2, mx, bn, bf, br]  -->
<!--     - M1 ~ T1\*M26 | M10 = 0 ov [s = ug1, ug2, mx, bn, bf, br] -->
<!--     - M1 ~ T1\*M27 | M25 = 1 ov [s = ug1, ug2, mx, bn, bf, br] -->
<!--     - M1 ~ T1\*M27 | M10 = 0 ov [s = ug1, ug2, mx, bn, bf, br] -->

<!-- * H9: Informational effects are stronger in informationally weak environments. -->
<!-- * H11: Informational effects are stronger in settings in which elections are believed to be free and fair. -->


```{r, include=F, cache=T}
# M11 - certainty
m1_m11c1_g <- results(dat = madat_iter, sims = n_iter,
                      depvar = "m1", interactvar = "m11", good = TRUE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m11_all_g.Rda")  # good news

m1_m11c1_b <- results(dat = madat_iter, sims = n_iter, 
                      depvar = "m1", interactvar = "m11", good = FALSE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m11_all_b.Rda") # bad news
```

```{r, include=F, cache=T}
# M26 - secret ballot
m1_m26c1_g <- results(dat = madat_iter, sims = n_iter, 
                      depvar = "m1", interactvar = "m26", good = TRUE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m26_all_g.Rda")  # good news
```

```{r, include=F, cache=T}
m1_m26c1_b <- results(dat = madat_iter, sims = n_iter, 
                      depvar = "m1", interactvar = "m26", good = FALSE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m26_all_b.Rda") # bad news

```

```{r, include=F, cache=T}
# M27 - free and fair election
m1_m27c1_g <- results(dat = madat_iter, sims = n_iter, 
                      depvar = "m1", interactvar = "m27", good = TRUE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m27_all_g.Rda")  # good news
```

```{r, include=F, cache=T}
m1_m27c1_b <- results(dat = madat_iter, sims = n_iter, 
                      depvar = "m1", interactvar = "m27", good = FALSE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m27_all_b.Rda") # bad news
```

```{r, results='asis', echo=FALSE}
  source("tab8_context_hetero.R")
  cat(readLines('tables/tab_11.8_context_hetero.tex'), sep = '\n')
```

\clearpage

### Table 11.9

<!-- * H10: Informational effects are stronger in more competitive elections. -->

<!--     - M1 ~ T1\*M25 | M10 = 1 & M25 >= median[M25]  ov [s = bn, br, mx, ug1]  -->
<!--     - M1 ~ T1\*M25 | M10 = 0 & M25 >= median[M25] ov [s = bn, br, mx, ug1] -->
<!--     - M1 ~ T1\*M25 | M10 = 1 & M25 < median[M25]  ov [s = bn, br, mx, ug1]  -->
<!--     - M1 ~ T1\*M25 | M10 = 0 & M25 < median[M25] ov [s = bn, br, mx, ug1]   -->

```{r, eval = T, include=F, cache=T}
# low competition ----
# good news
madat_m1_m25lpool_g <- madat_m1pool_g %>%
	drop_na(m25) %>%
	filter(!ctry %in% c("bf","ug2")) %>%
	group_by(ctry) %>%
	filter(m25 <= median(m25)) %>%
	ungroup()

m1_m25lc1_g <- results(dat = madat_m1_m25lpool_g, sims = n_iter,
                       ri_p = ri_action, file_rite_obj = "data/temp/r1_m1pool_m25l_g.Rda",
                       good = TRUE, depvar = "m1")
rm(madat_m1_m25lpool_g)
```

```{r, include=F, cache=T}
# bad news 
madat_m1_m25lpool_b <- madat_m1pool_b %>%
	drop_na(m25) %>%
	filter(!ctry %in% c("bf","ug2")) %>%
	group_by(ctry) %>%
	filter(m25 <= median(m25)) %>%
	ungroup()

m1_m25lc1_b <- results(dat = madat_m1_m25lpool_b, sims = n_iter,
                       ri_p = ri_action, file_rite_obj = "data/temp/r1_m1pool_m25l_b.Rda",
                       good = FALSE, depvar = "m1")
rm(madat_m1_m25lpool_b)

```

```{r, include=F, cache=T}

# high competition ----
# good news
madat_m1_m25hpool_g <- madat_m1pool_g %>%
	drop_na(m25) %>%
	filter(!ctry %in% c("bf","ug2")) %>%
	group_by(ctry) %>%
	filter(m25 > median(m25)) %>%
	ungroup()

m1_m25hc1_g <- results(dat = madat_m1_m25hpool_g, sims = n_iter,
                       ri_p = ri_action, file_rite_obj = "data/temp/r1_m1pool_m25h_g.Rda",
                       good = TRUE, depvar = "m1", skip_prep = TRUE)
rm(madat_m1_m25hpool_g)
```

```{r, include=F, cache=T}
# bad news regressions
madat_m1_m25hpool_b <- madat_m1pool_b %>%
	drop_na(m25) %>%
	filter(ctry!="bf"&ctry!="ug2") %>%
	group_by(ctry) %>%
	filter(m25 > median(m25)) %>%
	ungroup()


m1_m25hc1_b <- results(dat = madat_m1_m25hpool_b, sims = n_iter,
                       ri_p = ri_action, file_rite_obj = "data/temp/r1_m1pool_m25h_b.Rda",
                       good = FALSE, depvar = "m1", skip_prep = TRUE)
rm(madat_m1_m25hpool_b)
```

```{r, results='asis', echo=FALSE, eval=TRUE}
  source("tab9_competition.R")
  cat(readLines('tables/tab_11.9_competition.tex'), sep = '\n')
  
```

\clearpage

### Table 11.10
<!-- * H12: Information effects---both positive and negative---are stronger when the gap between voters' prior beliefs about candidates and the information provided is larger. -->
<!-- * H13: Informational effects are stronger the more the information relates directly to individual welfare. -->
<!-- * H14: Informational effects are stronger the more reliable and credible is the information _source_. -->

<!--     - M1 ~ T1\*N | M10 = 1 ov [s = bn, bf, ug1, ug2] -->
<!--     - M1 ~ T1\*N | M10 = 0 ov [s = bn, bf, br ug1, ug2]     -->
<!--     - M1 ~ T1\*M23 | M10 = 1 ov [s = bn, br, ug2] -->
<!--     - M1 ~ T1\*M23 | M10 = 0 ov [s = bn, br, ug2] -->
<!--     - M1 ~ T1\*M24 | M10 = 1 ov [s = ug1, ug2, mx, bn, bf, br] -->
<!--     - M1 ~ T1\*M24 | M10 = 0 ov [s = ug1, ug2, mx, bn, bf, br] -->

```{r, eval = T, include=F, cache=T}

t1nc1_g <- results(dat = madat_iter, sims = n_iter, depvar = "m1", good = TRUE, with_N = TRUE, exclude_councilors =FALSE,
                   ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_N_all_g.Rda")   #good news, nij

t1nc1_b <- results(dat = madat_iter, sims = n_iter, depvar = "m1", good = FALSE, with_N = TRUE, exclude_councilors =FALSE,
                   ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_N_all_b.Rda")  #bad news, nij
```
```{r, include=F, cache=T}

# M24 - credibliity
m1_m24c1_g <- results(dat = madat_iter, sims = n_iter, depvar = "m1", interactvar = "m24", good = TRUE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m24_all_g.Rda") #good news

m1_m24c1_b <- results(dat = madat_iter, sims = n_iter, depvar = "m1", interactvar = "m24", good = FALSE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m24_all_b.Rda") #bad news
```
```{r, include=F, cache=T}

# m23 - salience
m1_m23c1_g <- results(dat = madat_iter, sims = n_iter, depvar = "m1", interactvar = "m23", good = TRUE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m23_all_g.Rda")  #good news

m1_m23c1_b <- results(dat = madat_iter, sims = n_iter, depvar = "m1", interactvar = "m23", good = FALSE, exclude_councilors =FALSE,
                      ri_p = ri_action, file_rite_obj = "data/temp/ri_m1pool_m23_all_b.Rda") #bad news

```

```{r, results='asis', echo=FALSE, warning=FALSE}
  source("tab10_intervention_hetero.R")
  cat(readLines('tables/tab_11.10_intervention_hetero.tex'), sep = '\n')
```

\clearpage

# The Effects of Alternative Interventions Across Studies

### Table 11.13

```{r, include=F, cache=T}

# Load and append data
files <- list.files("data/temp/pubpvt", pattern = "pp_covinter", full.names = TRUE)
for (f in files) {
  load(f)
}

madat <- rbind.fill(ben, mexsur, ug1)
madat$inv_wts <- NA
madat$inv_wts2 <- NA

m1c1_g <- results(ri_p = "ignore", depvar = "m1", treat1and2 = TRUE, good = TRUE)
m1c2_g <- results(ri_p = "ignore", depvar = "m1", treat1and2 = TRUE, good = TRUE, 
                  country = "ben", weights = FALSE)
m1c3_g <- results(ri_p = "ignore", depvar = "m1", treat1and2 = TRUE, good = TRUE, 
                  country = "mex", weights = FALSE)
m1c4_g <- results(ri_p = "ignore", depvar = "m1", treat1and2 = TRUE, good = TRUE, 
                  country = "ug1", weights = FALSE)
f_g <- f_equalcoeff(estimates(depvar = "m1", treat1and2 = TRUE, good = TRUE, return_df = TRUE), "m1")

m1c1_b <- results(ri_p = "ignore", depvar = "m1", treat1and2 = TRUE, good = FALSE)
m1c2_b <- results(ri_p = "ignore", depvar = "m1", treat1and2 = TRUE, good = FALSE, 
                  country = "ben", weights = FALSE)
m1c3_b <- results(ri_p = "ignore", depvar = "m1", treat1and2 = TRUE, good = FALSE, 
                  country = "mex", weights = FALSE)
m1c4_b <- results(ri_p = "ignore", depvar = "m1", treat1and2 = TRUE, good = FALSE, 
                  country = "ug1", weights = FALSE)
f_b <- f_equalcoeff(estimates(depvar = "m1", treat1and2 = TRUE, good = TRUE, return_df = TRUE), "m1")

```

```{r, echo=F, results='asis'}
  source("tab13_pvt_pub_good.R")
  cat(readLines('tables/tab_11.13_pvt_pub_good.tex'), sep = '\n')
```
\clearpage

### Table 11.14
```{r, echo=F, results='asis'}
  source("tab14_pvt_pub_bad.R")
  cat(readLines('tables/tab_11.14_pvt_pub_bad.tex'), sep = '\n')
```


```{r, include=F}
if(export_to_book){
  all.tables <- list.files("tables")
  lapply(all.tables, function(x){
    temp <- readLines(paste0("tables/", x))
    writeLines(temp, file(paste0(book_dir, "/", x)))
   })}
```

